---
layout: post
title: First start PostgreSQL
category: cheatSheet
tags: Linux, PostgreSQL, СУБД.

---

# Начало работы с PostgreSQL

PostgreSQL — это кроссплатформенная объектно-реляционная СУБД с открытым исходным кодом. Из этой статьи вы узнаете, как установить PostgreSQL в Ubuntu Linux, подключиться к нему и выполнить пару простых SQL-запросов, а также о том, как настроить резервное копирование.

## Установка
Чтобы установить PostgreSQL 9.2 в Ubuntu 18.04, выполните следующие команды:
```
sudo apt update
sudo apt install postgresql postgresql-contrib
```
Подключимся к базе через оболочку:
`sudo -u postgres psql`

Создадим тестовую базу данных и тестового пользователя:
```
CREATE DATABASE dt;
CREATE USER usr WITH password 'qwerty';
GRANT ALL ON DATABASE dt TO usr;
```

Для выхода из оболочки введите команду `\q`.

## Создание базы
Теперь попробуем поработать с созданной базой данных от имени usr:
`psql -h localhost dt usr`

Создадим новую таблицу:
```
CREATE SEQUENCE user_ids;
CREATE TABLE users (
  id INTEGER PRIMARY KEY DEFAULT NEXTVAL('user_ids'),
  login CHAR(64),
  password CHAR(64));
```

В отличие от некоторых других СУБД, в PostgreSQL используются последовательности (sequences) вместо auto_increment. С помощью nextval мы можем получать уникальные числа для заданной последовательности:
`SELECT NEXTVAL('user_ids');`

Прописав в качестве значения по умолчанию для поля id таблицы users значение NEXTVAL('user_ids'), мы добились того же эффекта, что дает auto_increment. При добавлении новых записей в таблицу мы можем не указывать id, потому что уникальный id будет сгенерирован автоматически. Несколько таблиц могут использовать одну и ту же последовательность. Таким образом мы сможем гарантировать, что значения некоторых полей у этих таблиц не пересекаются. В этом смысле последовательности более гибки, чем auto_increment.

Точно такую же таблицу можно создать и при помощи всего лишь одной команды:
```
CREATE TABLE users2 (
  id SERIAL PRIMARY KEY,
  login CHAR(64),
  password CHAR(64));
```
В этом случае последовательность для поля id создается автоматически.

\d 			получить список всех доступных таблиц
\d <table> 			вывести описание таблицы <table>
\d+ 			выведет расширенную информацию по таблице
\l 			список баз данных
\c dbname 			переключится на базу данных
\? 			отображение справки

Важно отметить, что в PostgreSQL по умолчанию имена таблиц и столбцов приводятся к нижнему регистру. Если это поведение нежелательно, можно воспользоваться двойными кавычками:
`CREATE TABLE "anotherTable" ("someValue" VARCHAR(64));`

Еще одна особенность PostgreSQL, с которой могут возникнуть сложности в начале работы с этой СУБД — так называемые «схемы». Схема представляет собой что-то вроде пространства имен для таблиц, как бы каталог с таблицами внутри базы данных.

Создание схемы:
`CREATE SCHEMA bookings;`

В остальном работа с PostgreSQL мало чем отличается от работы с любой другой реляционной СУБД:
```
INSERT INTO users (login, password)
  VALUES ('afiskon', '123456');
SELECT * FROM users;
```

## Доступ к базе

При дефолтных настройках не удастся подключится к postgrs  с другой машины:
`psql -h 192.168.0.105 dt usr`

В ответ будет ошибка:
```
psql: could not connect to server: Connection refused
  Is the server running on host "192.168.0.105" and accepting
  TCP/IP connections on port 5432?
```

Чтобы исправить это, добавьте строку в файл `/etc/postgresql/9.2/main/postgresql.conf`:
`listen_addresses = 'localhost,192.168.0.105'`

в файл `/etc/postgresql/9.2/main/pg_hba.conf`:
`host    all    all    192.168.0.105/16    md5`

Для перезапуска posgres:
`sudo service postgresql restart`

## Резервное копирование
Резервное копирование в PostgreSQL выглядит примерно так:
`pg_dump -c -h 192.168.0.105 -U usr dt > dump.sql`

> для сжатия дамба базы используется флаг -Fc.

Восстановление из резервной копии:
`cat dump.sql | psql -h 192.168.0.105 dt usr`

## Настройка PostgreSQL 
Конфиг по умолчанию не предполагает использования его на бою. Перед использованием PostgreSQL в боевых условиях эти настройки обязательно нужно изменить под ваше железо и ваше приложение. Для быстрой настройки можно воспользоваться:
-	Cybertec PostgreSQL Configurator;
-	PgTune. 

## Конекты
Для управления конектами следует использовать PgBouncer. Хороший профит получается после превышения 100 конектов на инстанс.

